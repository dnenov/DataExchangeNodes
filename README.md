# DataExchangeNodes for Dynamo

Dynamo nodes for integrating with **Autodesk DataExchange** (ACC/BIM 360). Browse, select, and load geometry from DataExchange directly into Dynamo.

![Dynamo Version](https://img.shields.io/badge/Dynamo-4.1-blue)
![.NET](https://img.shields.io/badge/.NET-10.0--windows-purple)
![License](https://img.shields.io/badge/License-MIT-green)

---

## üì¶ Nodes Included

### 1. **Select Exchange**
Browse and select a DataExchange from Autodesk Construction Cloud (ACC).

- Opens the official DataExchange SDK browser UI
- Uses Dynamo's built-in authentication (no separate login required)
- Outputs an `Exchange` object with full metadata

**Category:** `ExchangeNodes.DataExchangeNodes.Selection`

**Output:**
| Port | Type | Description |
|------|------|-------------|
| `exchange` | `Exchange` | Selected exchange with metadata (title, project, IDs, URNs, timestamps, etc.) |

### 2. **LoadGeometryFromExchange.Load**
Loads geometry from a DataExchange as native Dynamo geometry objects.

**Category:** `DataExchangeNodes.DataExchange`

**Inputs:**
| Port | Type | Default | Description |
|------|------|---------|-------------|
| `exchange` | `Exchange` | *required* | Exchange object from SelectExchange node |
| `unit` | `string` | `"kUnitType_CentiMeter"` | Unit type for geometry conversion |

**Unit Options:**
- `kUnitType_CentiMeter` (default)
- `kUnitType_Meter`
- `kUnitType_Feet`
- `kUnitType_Inch`

**Outputs (MultiReturn):**
| Port | Type | Description |
|------|------|-------------|
| `geometries` | `List<Geometry>` | Dynamo geometry objects (Solids, Surfaces, Curves, Points) |
| `log` | `string` | Diagnostic messages for debugging |
| `success` | `bool` | Whether the operation succeeded |

### 3. **ExportGeometryToSMB.ExportToSMB** (In Development)
Exports Dynamo geometry objects to SMB file format using ProtoGeometry.

**Category:** `DataExchangeNodes.DataExchange`

**Inputs:**
| Port | Type | Default | Description |
|------|------|---------|-------------|
| `geometries` | `List<Geometry>` | *required* | Dynamo geometry objects to export |
| `outputFilePath` | `string` | *optional* | Full path where SMB file should be saved (auto-generated if empty) |
| `unit` | `string` | `"kUnitType_CentiMeter"` | Unit type for geometry |

**Outputs (MultiReturn):**
| Port | Type | Description |
|------|------|-------------|
| `smbFilePath` | `string` | Path to created SMB file |
| `log` | `string` | Diagnostic messages |
| `success` | `bool` | Whether export succeeded |

### 4. **ConvertSmbToStep.ConvertSmbToStep** (Planned)
Converts SMB files to STEP format using Autodesk.DesignTranslator.NET.

**Category:** `DataExchangeNodes.DataExchange`

**Inputs:**
| Port | Type | Default | Description |
|------|------|---------|-------------|
| `smbFilePath` | `string` | *required* | Path to input SMB file |
| `outputStepPath` | `string` | *optional* | Path for output STEP file (auto-generated if empty) |
| `logFilePath` | `string` | *optional* | Path for translation log file |

**Outputs (MultiReturn):**
| Port | Type | Description |
|------|------|-------------|
| `stepFilePath` | `string` | Path to created STEP file |
| `log` | `string` | Diagnostic messages |
| `success` | `bool` | Whether conversion succeeded |

### 5. **UploadStepToExchange.UploadStepToExchange** (Planned)
Uploads STEP geometry files to a DataExchange using public async methods.

**Category:** `DataExchangeNodes.DataExchange`

**Inputs:**
| Port | Type | Default | Description |
|------|------|---------|-------------|
| `exchange` | `Exchange` | *required* | Exchange object from SelectExchange node |
| `stepFilePath` | `string` | *required* | Path to STEP file to upload |
| `elementName` | `string` | `"ExportedGeometry"` | Name for the new element |
| `elementId` | `string` | *optional* | Unique ID for element (auto-generated if empty) |
| `unit` | `string` | `"kUnitType_CentiMeter"` | Unit type for geometry |

**Outputs (MultiReturn):**
| Port | Type | Description |
|------|------|-------------|
| `elementId` | `string` | ID of created element |
| `log` | `string` | Diagnostic messages |
| `success` | `bool` | Whether upload succeeded |

---

## ‚ö†Ô∏è Important: Two Different SMB File Formats

**Critical Discovery:** There are **two different file formats** both using the `.smb` extension:

### 1. **DX-Compatible SMB** (Binary ASM Format)
- **Header:** Starts with `ASM BinaryFile4`
- **Contains:** String `"Autodesk Translation Framework"`
- **Format:** Binary ASM/ShapeManager format
- **Usage:** What DataExchange SDK expects and works with
- **Generated by:** DataExchange SDK, Autodesk Translation Framework (ATF)

### 2. **ProtoGeometry SMB** (SAT-like Text Format)
- **Header:** Starts with `700 0 2 0`
- **Contains:** String `"LibG 20 ASM"`
- **Format:** SAT-style text representation (ACIS/ASM text format)
- **Usage:** What ProtoGeometry `ExportToSMB()` generates
- **Generated by:** Dynamo's ProtoGeometry geometry kernel

### Why This Matters

- **DataExchange uploads** require the **DX-Compatible SMB** format (binary ASM)
- **ProtoGeometry exports** create the **SAT-like text format**
- These are **not directly compatible** - conversion is needed

### Detecting SMB Format

You can detect which format you have by reading the first ~16 bytes:

```csharp
// Read first 16 bytes
byte[] header = new byte[16];
using (FileStream fs = File.OpenRead(smbFilePath))
{
    fs.Read(header, 0, 16);
}

string headerStr = Encoding.ASCII.GetString(header);

if (headerStr.StartsWith("ASM BinaryFile4"))
{
    // DX-Compatible SMB (binary ASM)
}
else if (headerStr.StartsWith("700 0 2 0"))
{
    // ProtoGeometry SMB (SAT-like text)
}
```

### Solution: SMB ‚Üí STEP Conversion

Since the formats are incompatible, we use **Autodesk.DesignTranslator.NET.dll** to convert:

1. **ProtoGeometry SMB** ‚Üí **STEP** (using DesignTranslator)
2. **STEP** ‚Üí **DX-Compatible SMB** (or upload STEP directly to DataExchange)

This is why `ConvertSmbToStep` and `UploadStepToExchange` nodes are being developed - they provide a reliable conversion path using the public Autodesk DesignTranslator API.

---

## üõ†Ô∏è Prerequisites

### Required Software

1. **Dynamo** 4.1+ (Standalone or Revit)
   - Must be logged in with an Autodesk account
   - ACC/BIM 360 project access required

2. **Visual Studio 2022** or later
   - .NET 10.0 SDK
   - Windows Desktop development workload

3. **Python 3.x** (for package deployment script)

4. **DynamoATF Package** (for native geometry dependencies)
   - Must be installed in Dynamo packages folder
   - Location: `%APPDATA%\Dynamo\Dynamo Core\3.6\packages\DynamoATF`

### Required Dependencies

The project requires native DLLs from **DynamoATF** for geometry translation:

```
native/FDXToCollab/
‚îú‚îÄ‚îÄ ACIS Kernel (37 DLLs, ~60MB)
‚îú‚îÄ‚îÄ ATF Translation Framework (40 DLLs, ~50MB)
‚îú‚îÄ‚îÄ Autodesk Translators (8 DLLs)
‚îú‚îÄ‚îÄ Autodesk Geometry Utilities (8 DLLs)
‚îú‚îÄ‚îÄ Open Design Alliance/Teigha (20 DLLs, ~15MB)
‚îú‚îÄ‚îÄ STEP/IGES Libraries (~15MB)
‚îî‚îÄ‚îÄ Other Dependencies (TBB, Protobuf, etc.)
```

> **Note:** See `native/README.md` for complete DLL documentation.

---

## üèóÔ∏è Building the Project

### Option 1: Visual Studio

1. Open `DataExchangeNodes.sln` in Visual Studio 2022
2. Restore NuGet packages (automatic on build)
3. Build the solution:
   - **Debug:** `Ctrl+Shift+B` or Build ‚Üí Build Solution
   - **Release:** Build ‚Üí Build Solution (with Release configuration)

### Option 2: Command Line

```powershell
cd $(APPDATA)Documents\GitHub\DataExchangeNodes

# Restore dependencies
dotnet restore

# Build Debug
dotnet build --configuration Debug

# Build Release
dotnet build --configuration Release
```

### Build Output

After building, binaries are placed in:
```
bin/
‚îú‚îÄ‚îÄ Debug/
‚îÇ   ‚îî‚îÄ‚îÄ 4.1.0-beta3200/
‚îÇ       ‚îî‚îÄ‚îÄ DataExchangeNodes/
‚îÇ           ‚îú‚îÄ‚îÄ ExchangeNodes.dll
‚îÇ           ‚îú‚îÄ‚îÄ ExchangeNodes.NodeModels.dll
‚îÇ           ‚îú‚îÄ‚îÄ ExchangeNodes.NodeViews.dll
‚îÇ           ‚îú‚îÄ‚îÄ FDXToCollab/           # Native DLLs
‚îÇ           ‚îî‚îÄ‚îÄ ... (other dependencies)
‚îî‚îÄ‚îÄ Release/
    ‚îî‚îÄ‚îÄ ... (same structure)
```

---

## üöÄ Installing / Deploying to Dynamo

### Automatic Deployment (Post-Build)

The build process **automatically deploys** the package to Dynamo:

1. **PostBuildStep.bat** runs `prepareDynamoPackage.py`
2. Creates `dynamo-package/` folder with proper structure
3. Copies to both **Dynamo Core** and **Dynamo Revit** package folders:

```
%APPDATA%\Dynamo\Dynamo Core\4.1\packages\DataExchangeNodes\
%APPDATA%\Dynamo\Dynamo Revit\4.1\packages\DataExchangeNodes\
```

### Manual Deployment

If automatic deployment fails, manually copy the `dynamo-package/` folder:

```powershell
# Copy to Dynamo Core
Copy-Item -Recurse .\dynamo-package\* "$env:APPDATA\Dynamo\Dynamo Core\4.1\packages\DataExchangeNodes\"

# Copy to Dynamo Revit
Copy-Item -Recurse .\dynamo-package\* "$env:APPDATA\Dynamo\Dynamo Revit\4.1\packages\DataExchangeNodes\"
```

### Package Structure

```
DataExchangeNodes/
‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îú‚îÄ‚îÄ ExchangeNodes.dll              # Zero-touch nodes
‚îÇ   ‚îú‚îÄ‚îÄ ExchangeNodes.NodeModels.dll   # NodeModel definitions
‚îÇ   ‚îú‚îÄ‚îÄ ExchangeNodes.NodeViews.dll    # WPF view customizations
‚îÇ   ‚îú‚îÄ‚îÄ FDXToCollab/                   # Native geometry DLLs
‚îÇ   ‚îú‚îÄ‚îÄ WebUI/                         # DataExchange UI assets
‚îÇ   ‚îî‚îÄ‚îÄ ... (SDK dependencies)
‚îú‚îÄ‚îÄ dyf/                               # Custom node definitions (empty)
‚îú‚îÄ‚îÄ extra/                             # Additional resources (empty)
‚îî‚îÄ‚îÄ pkg.json                           # Package manifest
```

---

## üìã Usage in Dynamo

### Basic Workflow

1. **Launch Dynamo** (Standalone or in Revit)
2. **Log in** to your Autodesk account (if not already)
3. Search for `Select Exchange` in the node library
4. Place the node on the canvas
5. Click the **Select** button to open the DataExchange browser
6. Browse and select an exchange from ACC
7. Connect the `exchange` output to `LoadGeometryFromExchange.Load`
8. Run the graph to load geometry

### Example Graph

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Select Exchange      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ    [Select]     ‚îÇ   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂ exchange
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ   Selected: My Model   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ LoadGeometryFromExchange‚îÇ
‚îÇ         .Load          ‚îÇ
‚îÇ  exchange ‚óè‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂ geometries
‚îÇ  unit ‚óè‚îÄ"kUnitType_Feet"‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂ log
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÄ‚îÄ‚îÄ‚ñ∂ success
            ‚îÇ
            ‚ñº
    [Dynamo Geometry]
```

### Supported Geometry Types

| Type | Support | Notes |
|------|---------|-------|
| **Brep** (Solids/Surfaces) | ‚úÖ Full | Converted via ACIS native pointers |
| **Curves** | ‚úÖ Full | Lines, arcs, splines |
| **Points** | ‚úÖ Full | XYZ coordinates |
| **IndexMesh** | ‚ö†Ô∏è Partial | Not yet implemented |
| **Groups/Layers** | ‚ÑπÔ∏è Container | Children extracted automatically |

---

## üîß Project Structure

```
DataExchangeNodes/
‚îú‚îÄ‚îÄ DataExchangeNodes.sln              # Solution file
‚îú‚îÄ‚îÄ nodes/                             # Zero-touch nodes
‚îÇ   ‚îú‚îÄ‚îÄ ExchangeNodes.csproj
‚îÇ   ‚îî‚îÄ‚îÄ DataExchange/
‚îÇ       ‚îú‚îÄ‚îÄ Exchange.cs                # Exchange data model
‚îÇ       ‚îú‚îÄ‚îÄ DataExchangeUtils.cs       # AST helper functions
‚îÇ       ‚îú‚îÄ‚îÄ LoadGeometryFromExchange.cs # Geometry loader
‚îÇ       ‚îú‚îÄ‚îÄ ExportGeometryToSMB.cs     # SMB export (uses reflection)
‚îÇ       ‚îú‚îÄ‚îÄ ConvertSmbToStep.cs        # SMB‚ÜíSTEP conversion (planned)
‚îÇ       ‚îî‚îÄ‚îÄ UploadStepToExchange.cs    # STEP upload (planned)
‚îú‚îÄ‚îÄ node_models/                       # NodeModel definitions
‚îÇ   ‚îú‚îÄ‚îÄ ExchangeNodes.NodeModels.csproj
‚îÇ   ‚îî‚îÄ‚îÄ DataExchange/
‚îÇ       ‚îî‚îÄ‚îÄ SelectExchangeElements.cs  # Select Exchange node
‚îú‚îÄ‚îÄ node_views/                        # WPF view customizations
‚îÇ   ‚îú‚îÄ‚îÄ ExchangeNodes.NodeViews.csproj
‚îÇ   ‚îî‚îÄ‚îÄ DataExchange/
‚îÇ       ‚îú‚îÄ‚îÄ SelectExchangeElementsViewCustomization.cs
‚îÇ       ‚îú‚îÄ‚îÄ DynamoAuthProvider.cs      # Auth bridge to Dynamo
‚îÇ       ‚îú‚îÄ‚îÄ ReadExchangeModel.cs       # DataExchange SDK model
‚îÇ       ‚îî‚îÄ‚îÄ MainThreadInvoker.cs       # WPF thread dispatcher
‚îú‚îÄ‚îÄ native/                            # Native DLLs
‚îÇ   ‚îú‚îÄ‚îÄ FDXToCollab/                   # 117 DLLs from DynamoATF
‚îÇ   ‚îî‚îÄ‚îÄ README.md                      # DLL documentation
‚îú‚îÄ‚îÄ extras/                            # Build scripts
‚îÇ   ‚îú‚îÄ‚îÄ package-template/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pkg.json                   # Package manifest template
‚îÇ   ‚îî‚îÄ‚îÄ prepareDynamoPackage.py        # Deployment script
‚îú‚îÄ‚îÄ dynamo-package/                    # Built package (generated)
‚îî‚îÄ‚îÄ PostBuildStep.bat                  # Post-build automation
```

---

## üì¶ NuGet Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| `DynamoVisualProgramming.Core` | 4.1.0-beta3200 | Core Dynamo types |
| `DynamoVisualProgramming.DynamoServices` | 4.1.0-beta3200 | Dynamo services |
| `DynamoVisualProgramming.ZeroTouchLibrary` | 4.1.0-beta3200 | Zero-touch support |
| `DynamoVisualProgramming.WpfUILibrary` | 4.1.0-beta3200 | WPF node views |
| `Autodesk.DataExchange.UI` | 6.2.12-beta | DataExchange SDK browser UI |
| `Newtonsoft.Json` | 13.0.3 | JSON serialization |

### Native DLL References

The following DLLs are referenced from `native/FDXToCollab/` (already deployed):

| DLL | Purpose |
|-----|---------|
| `Autodesk.DesignTranslator.NET.dll` | .NET wrapper for geometry translation |
| `Autodesk.DesignTranslator.STEP.dll` | STEP format support for translation |
| `Autodesk.DesignTranslator.SAT.dll` | SAT format support |
| `Autodesk.DesignTranslator.OBJ.dll` | OBJ format support |
| `Autodesk.DesignTranslator.SVF.dll` | SVF format support |
| `Autodesk.GeometryUtilities.dll` | High-level geometry utilities |
| `Autodesk.GeometryPrimitives.Data.dll` | Geometry data structures |

> **Note:** All native DLLs are in `native/FDXToCollab/` and are automatically copied to output during build.

---

## üîê Authentication

This package uses **Dynamo's built-in authentication**. No additional login or API keys are required.

### How It Works

1. `DynamoAuthProvider` bridges Dynamo's `AuthenticationManager` to DataExchange SDK
2. Supports both **Dynamo Core** (IDSDKManager) and **Dynamo Revit** (RevitOAuth2Provider)
3. Token is automatically retrieved from the active session
4. Works with existing ACC/BIM 360 project permissions

### Troubleshooting Auth Issues

- **"Please log in"**: Click the user icon in Dynamo and sign in
- **"Not logged in"**: Refresh Dynamo or restart the application
- **"Token expired"**: Re-authenticate in Dynamo

---

## üêõ Troubleshooting

### Common Issues

| Issue | Solution |
|-------|----------|
| Nodes not appearing in library | Restart Dynamo after build; check `pkg.json` is deployed |
| "Could not load assembly" errors | Ensure all native DLLs in `FDXToCollab/` are present |
| DataExchange UI doesn't open | Check Dynamo authentication; verify network connectivity |
| Geometry load returns empty | Check `log` output for errors; verify exchange has geometry |
| Package not deploying | Run `prepareDynamoPackage.py` manually with correct args |
| SMB upload fails | Verify SMB file is DX-compatible format (binary ASM); use `ConvertSmbToStep` if needed |
| "SMB format not recognized" | Check SMB file header - should start with `ASM BinaryFile4` for DataExchange |

### SMB Format Issues

**Problem:** SMB file exported from ProtoGeometry doesn't work with DataExchange upload.

**Cause:** ProtoGeometry exports SAT-like text format, but DataExchange expects binary ASM format.

**Solution:** 
1. Use `ConvertSmbToStep` to convert ProtoGeometry SMB ‚Üí STEP
2. Use `UploadStepToExchange` to upload the STEP file directly
3. DataExchange SDK will handle STEP format natively

**Detection:** Check the first 16 bytes of your SMB file:
- `ASM BinaryFile4...` = DX-compatible ‚úÖ
- `700 0 2 0...` = ProtoGeometry format ‚ö†Ô∏è (needs conversion)

### Checking Logs

Dynamo console shows detailed logs prefixed with `SelectExchangeElements:` and `ReadExchangeModel:`.

DataExchange SDK logs are written to:
```
%APPDATA%\Dynamo\DataExchange\logs\
```

---

## üìÑ License

MIT License - See [LICENSE](LICENSE) for details.

---

## üîÑ Current Development Status

### Completed ‚úÖ
- Exchange selection and browsing (Select Exchange node)
- Geometry loading from DataExchange (LoadGeometryFromExchange)
- SMB export from Dynamo geometry (ExportGeometryToSMB) - uses reflection-based implementation
- Reflection-based upload pipeline working with DX-compatible SMB format

### In Progress üöß
- **SMB ‚Üí STEP conversion** using Autodesk.DesignTranslator.NET.dll public API
  - Separate `ConvertSmbToStep` node for isolated testing
  - Uses public ProducerOptions/ConsumerOptions (no reflection)
  - Defensive error handling with detailed diagnostics
  
- **STEP upload to DataExchange** using public async methods
  - New `UploadStepToExchange` node
  - Uses public async methods (GetElementDataModelAsync, SaveAsync, etc.)
  - No reflection for async method calls
  - Well-encapsulated methods for maintainability

### Architecture Decisions

- **Reflection vs Public API:** 
  - SMB export/upload uses reflection for internal SDK methods (working successfully)
  - STEP conversion/upload uses public API only (Autodesk.DesignTranslator, public async methods)
  - Hybrid approach: use public API when available, reflection when necessary

- **Code Organization:**
  - Each feature in separate class/file
  - Methods are small, well-encapsulated (< 50 lines each)
  - Single Responsibility Principle applied throughout
  - Detailed diagnostics logging for debugging

- **Error Handling:**
  - Defensive validation at method boundaries
  - Detailed error messages in diagnostics output
  - Graceful degradation when possible
  - Never silent failures

## üôè Acknowledgments

- **DynamoATF** - Native geometry translation infrastructure
- **Autodesk DataExchange SDK** - Browser UI and API client
- **Autodesk DesignTranslator** - SMB/STEP/OBJ format translation
- **Dynamo Team** - Authentication and geometry kernel integration

